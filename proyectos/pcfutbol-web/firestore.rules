rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Leagues: read-only for everyone
    match /leagues/{leagueId} {
      allow read: if true;
      allow write: if false;
    }
    match /leagues_v2/{leagueId} {
      allow read: if true;
      allow write: if false;
    }

    // Teams: read-only for everyone
    match /teams/{teamId} {
      allow read: if true;
      allow write: if false;
    }
    match /teams_v2/{teamId} {
      allow read: if true;
      allow write: if false;
    }

    // Game saves: authenticated users can manage their OWN saves
    match /saves/{saveId} {
      allow read, write: if request.auth != null && (
        resource == null || resource.data.userId == request.auth.uid
      );
      allow create: if request.auth != null;
    }
    match /save_slots/{docId} {
      allow read, write: if request.auth != null && (
        resource == null || resource.data.userId == request.auth.uid
      );
      allow create: if request.auth != null;
    }

    // ProManager saves (document ID = uid_promanager)
    match /promanager_saves/{saveId} {
      allow read, write: if request.auth != null && (
        resource == null || resource.data.userId == request.auth.uid
      );
      allow create: if request.auth != null;
    }

    // User profiles
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /users/{userId}/{sub=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Contrarreloj saves
    match /contrarreloj_saves/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Contrarreloj ranking
    match /contrarreloj_ranking/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // === RANKED 1v1 ===

    // Ranked queue — only own entry
    match /ranked_queue/{userId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Ranked matches — only participants can update
    match /ranked_matches/{matchId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        resource.data.player1.uid == request.auth.uid ||
        resource.data.player2.uid == request.auth.uid
      );
    }

    // Ranked players — only own stats
    match /ranked_players/{userId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    // === EDITIONS ===

    // Editions (approved packs - public read)
    match /editions/{editionId} {
      allow read: if true;
      allow write: if false;
    }

    // Editions pending review (user submissions)
    match /editions_pending/{pendingId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }

    // Default: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
