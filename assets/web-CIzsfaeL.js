import{W as C}from"./index-C4NeMn89.js";class m extends C{constructor(){super()}parseJwt(e){const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(t).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}async loadScript(e){return new Promise((o,t)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.onload=()=>{o()},r.onerror=t,document.body.appendChild(r)})}}m.OAUTH_STATE_KEY="social_login_oauth_pending";class z extends m{constructor(){super(...arguments),this.clientId=null,this.redirectUrl=null,this.scriptLoaded=!1,this.scriptUrl="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js",this.useProperTokenExchange=!1}async initialize(e,o,t=!1){this.clientId=e,this.redirectUrl=o||null,this.useProperTokenExchange=t,e&&await this.loadAppleScript()}async login(e){if(!this.clientId)throw new Error("Apple Client ID not set. Call initialize() first.");if(!this.scriptLoaded)throw new Error("Apple Sign-In script not loaded.");return new Promise((o,t)=>{var r,i;AppleID.auth.init({clientId:(r=this.clientId)!==null&&r!==void 0?r:"",scope:((i=e.scopes)===null||i===void 0?void 0:i.join(" "))||"name email",redirectURI:this.redirectUrl||window.location.href,state:e.state,nonce:e.nonce,usePopup:!0}),AppleID.auth.signIn().then(n=>{var a,s,l,c,y;let f=null;this.useProperTokenExchange?f=null:f={token:n.authorization.code||""};const k=Object.assign({profile:{user:n.user||"",email:((a=n.user)===null||a===void 0?void 0:a.email)||null,givenName:((l=(s=n.user)===null||s===void 0?void 0:s.name)===null||l===void 0?void 0:l.firstName)||null,familyName:((y=(c=n.user)===null||c===void 0?void 0:c.name)===null||y===void 0?void 0:y.lastName)||null},accessToken:f,idToken:n.authorization.id_token||null},this.useProperTokenExchange&&{authorizationCode:n.authorization.code});o({provider:"apple",result:k})}).catch(n=>{t(n)})})}async logout(){console.log("Apple logout: Session should be managed on the client side")}async isLoggedIn(){return console.log("Apple login status should be managed on the client side"),{isLoggedIn:!1}}async getAuthorizationCode(){throw console.log("Apple authorization code should be stored during login"),new Error("Apple authorization code not available")}async refresh(){console.log("Apple refresh not available on web")}async loadAppleScript(){if(!this.scriptLoaded)return this.loadScript(this.scriptUrl).then(()=>{this.scriptLoaded=!0})}}class K extends m{constructor(){super(...arguments),this.appId=null,this.scriptLoaded=!1,this.locale="en_US"}async initialize(e,o){this.appId=e,o&&(this.locale=o),e&&(await this.loadFacebookScript(this.locale),FB.init({appId:this.appId,version:"v17.0",xfbml:!0,cookie:!0}))}async login(e){if(!this.appId)throw new Error("Facebook App ID not set. Call initialize() first.");return new Promise((o,t)=>{FB.login(r=>{r.status==="connected"?FB.api("/me",{fields:"id,name,email,picture"},i=>{var n,a;const s={accessToken:{token:r.authResponse.accessToken,userId:r.authResponse.userID},profile:{userID:i.id,name:i.name,email:i.email||null,imageURL:((a=(n=i.picture)===null||n===void 0?void 0:n.data)===null||a===void 0?void 0:a.url)||null,friendIDs:[],birthday:null,ageRange:null,gender:null,location:null,hometown:null,profileURL:null},idToken:null};o({provider:"facebook",result:s})}):t(new Error("Facebook login failed"))},{scope:e.permissions.join(",")})})}async logout(){return new Promise(e=>{FB.logout(()=>e())})}async isLoggedIn(){return new Promise(e=>{FB.getLoginStatus(o=>{e({isLoggedIn:o.status==="connected"})})})}async getAuthorizationCode(){return new Promise((e,o)=>{FB.getLoginStatus(t=>{var r;t.status==="connected"?e({accessToken:((r=t.authResponse)===null||r===void 0?void 0:r.accessToken)||""}):o(new Error("No Facebook authorization code available"))})})}async refresh(e){await this.login(e)}async loadFacebookScript(e){if(this.scriptLoaded)return;const o=document.querySelector('script[src*="connect.facebook.net"]');return o&&o.remove(),this.loadScript(`https://connect.facebook.net/${e}/sdk.js`).then(()=>{this.scriptLoaded=!0})}}class G extends m{constructor(){super(...arguments),this.clientId=null,this.loginType="online",this.GOOGLE_TOKEN_REQUEST_URL="https://www.googleapis.com/oauth2/v3/tokeninfo",this.GOOGLE_STATE_KEY="capgo_social_login_google_state"}async initialize(e,o,t,r){this.clientId=e,o&&(this.loginType=o),this.hostedDomain=t,this.redirectUrl=r}async login(e){if(!this.clientId)throw new Error("Google Client ID not set. Call initialize() first.");let o=e.scopes||[];o.length>0?(o.includes("https://www.googleapis.com/auth/userinfo.email")||o.push("https://www.googleapis.com/auth/userinfo.email"),o.includes("https://www.googleapis.com/auth/userinfo.profile")||o.push("https://www.googleapis.com/auth/userinfo.profile"),o.includes("openid")||o.push("openid")):o=["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile","openid"];const t=e.nonce||Math.random().toString(36).substring(2);return this.traditionalOAuth({scopes:o,nonce:t,hostedDomain:this.hostedDomain,prompt:e.prompt})}async logout(){if(this.loginType==="offline")return Promise.reject("Offline login doesn't store tokens. logout is not available");const e=this.getGoogleState();e&&await this.rawLogoutGoogle(e.accessToken)}async isLoggedIn(){if(this.loginType==="offline")return Promise.reject("Offline login doesn't store tokens. isLoggedIn is not available");const e=this.getGoogleState();if(!e)return{isLoggedIn:!1};try{const o=await this.accessTokenIsValid(e.accessToken),t=this.idTokenValid(e.idToken);if(o&&t)return{isLoggedIn:!0};try{await this.rawLogoutGoogle(e.accessToken,!1)}catch(r){console.error("Access token is not valid, but cannot logout",r)}return{isLoggedIn:!1}}catch(o){return Promise.reject(o)}}async getAuthorizationCode(){if(this.loginType==="offline")return Promise.reject("Offline login doesn't store tokens. getAuthorizationCode is not available");const e=this.getGoogleState();if(!e)throw new Error("No Google authorization code available");try{const o=await this.accessTokenIsValid(e.accessToken),t=this.idTokenValid(e.idToken);if(o&&t)return{accessToken:e.accessToken,jwt:e.idToken};try{await this.rawLogoutGoogle(e.accessToken,!1)}catch(r){console.error("Access token is not valid, but cannot logout",r)}throw new Error("No Google authorization code available")}catch(o){return Promise.reject(o)}}async refresh(){return Promise.reject("Not implemented")}handleOAuthRedirect(e){const o=e.searchParams,t=o.get("error");if(t)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:o.get("error_description")||t};const r=o.get("code");if(r&&o.has("scope"))return{provider:"google",result:{serverAuthCode:r,responseType:"offline"}};const i=e.hash.substring(1);if(console.log("handleOAuthRedirect",e.hash),!i)return null;const n=new URLSearchParams(i),a=n.get("error");if(a)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:n.get("error_description")||a};console.log("handleOAuthRedirect ok");const s=n.get("access_token"),l=n.get("id_token");if(s&&l){localStorage.removeItem(m.OAUTH_STATE_KEY);const c=this.parseJwt(l);return{provider:"google",result:{accessToken:{token:s},idToken:l,profile:{email:c.email||null,familyName:c.family_name||null,givenName:c.given_name||null,id:c.sub||null,name:c.name||null,imageUrl:c.picture||null},responseType:"online"}}}return null}async accessTokenIsValid(e){const o=`${this.GOOGLE_TOKEN_REQUEST_URL}?access_token=${encodeURIComponent(e)}`;try{const t=await fetch(o);if(!t.ok)return console.log(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response not successful. Status code: ${t.status}. Assuming that the token is not valid`),!1;const r=await t.text();if(!r)throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is null`);let i;try{i=JSON.parse(r)}catch(s){throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${s}`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response body is not valid JSON. Error: ${s}`)}const n=i.expires_in;if(n==null)throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. Response JSON does not include 'expires_in'.`);let a;try{if(a=parseInt(n,10),isNaN(a))throw new Error("'expires_in' is not a valid integer")}catch(s){throw console.error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${n} is not a valid integer. Error: ${s}`),new Error(`Invalid response from ${this.GOOGLE_TOKEN_REQUEST_URL}. 'expires_in': ${n} is not a valid integer. Error: ${s}`)}return a>5}catch(t){throw console.error(t),t}}idTokenValid(e){try{const o=this.parseJwt(e),t=Math.ceil(Date.now()/1e3)+5;return o.exp&&t<o.exp}catch{return!1}}async rawLogoutGoogle(e,o=null){if(o===null&&(o=await this.accessTokenIsValid(e)),o===!0){try{await fetch(`https://accounts.google.com/o/oauth2/revoke?token=${encodeURIComponent(e)}`),this.clearStateGoogle()}catch{}return}else{this.clearStateGoogle();return}}persistStateGoogle(e,o){try{window.localStorage.setItem(this.GOOGLE_STATE_KEY,JSON.stringify({accessToken:e,idToken:o}))}catch(t){console.error("Cannot persist state google",t)}}clearStateGoogle(){try{window.localStorage.removeItem(this.GOOGLE_STATE_KEY)}catch(e){console.error("Cannot clear state google",e)}}getGoogleState(){try{const e=window.localStorage.getItem(this.GOOGLE_STATE_KEY);if(!e)return null;const{accessToken:o,idToken:t}=JSON.parse(e);return{accessToken:o,idToken:t}}catch(e){return console.error("Cannot get state google",e),null}}async traditionalOAuth({scopes:e,hostedDomain:o,nonce:t,prompt:r}){var i;const n=[...new Set([...e||[],"openid"])],a=new URLSearchParams(Object.assign(Object.assign({client_id:(i=this.clientId)!==null&&i!==void 0?i:"",redirect_uri:this.redirectUrl||window.location.origin+window.location.pathname,response_type:this.loginType==="offline"?"code":"token id_token",scope:n.join(" ")},t&&{nonce:t}),{include_granted_scopes:"true",state:"popup"}));o!==void 0&&a.append("hd",o),r!==void 0&&a.append("prompt",r);const s=`https://accounts.google.com/o/oauth2/v2/auth?${a.toString()}`,l=500,c=600,y=window.screenX+(window.outerWidth-l)/2,f=window.screenY+(window.outerHeight-c)/2;localStorage.setItem(m.OAUTH_STATE_KEY,JSON.stringify({provider:"google",loginType:this.loginType,nonce:t}));const k=window.open(s,"Google Sign In",`width=${l},height=${c},left=${y},top=${f},popup=1`);let A,u;const b=`google_oauth_${t||Date.now()}`;let O=null;try{O=new BroadcastChannel(b)}catch{}return new Promise((I,v)=>{if(!k){v(new Error("Failed to open popup"));return}const E=()=>{window.removeEventListener("message",P),clearInterval(A),clearTimeout(u),O&&O.close()},U=g=>{if(this.loginType==="online"){const{accessToken:_,idToken:p}=g;if(_&&p){const w=this.parseJwt(p);this.persistStateGoogle(_.token,p),I({provider:"google",result:{accessToken:{token:_.token},idToken:p,profile:{email:w.email||null,familyName:w.family_name||null,givenName:w.given_name||null,id:w.sub||null,name:w.name||null,imageUrl:w.picture||null},responseType:"online"}})}else v(new Error("Invalid OAuth response: missing accessToken or idToken"))}else{const{serverAuthCode:_}=g;if(!_){v(new Error("Invalid OAuth response: missing serverAuthCode"));return}I({provider:"google",result:{responseType:"offline",serverAuthCode:_}})}},P=g=>{var _,p,w,S;if(!(g.origin!==window.location.origin||!((p=(_=g.data)===null||_===void 0?void 0:_.source)===null||p===void 0)&&p.startsWith("angular"))){if(((w=g.data)===null||w===void 0?void 0:w.type)==="oauth-response")E(),U(g.data);else if(((S=g.data)===null||S===void 0?void 0:S.type)==="oauth-error"){E();const d=g.data.error||"User cancelled the OAuth flow";v(new Error(d))}}};O&&(O.onmessage=g=>{var _;const p=g.data;if(!(!((_=p?.source)===null||_===void 0)&&_.toString().startsWith("angular"))){if(p?.type==="oauth-response")E(),U(p);else if(p?.type==="oauth-error"){E();const w=p.error||"User cancelled the OAuth flow";v(new Error(w))}}}),window.addEventListener("message",P),u=setTimeout(()=>{E();try{k.close()}catch{}v(new Error("OAuth timeout"))},3e5),A=setInterval(()=>{try{k.closed&&(E(),v(new Error("Popup closed")))}catch{clearInterval(A)}},1e3)})}}var j=function(T,e){var o={};for(var t in T)Object.prototype.hasOwnProperty.call(T,t)&&e.indexOf(t)<0&&(o[t]=T[t]);if(T!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,t=Object.getOwnPropertySymbols(T);r<t.length;r++)e.indexOf(t[r])<0&&Object.prototype.propertyIsEnumerable.call(T,t[r])&&(o[t[r]]=T[t[r]]);return o};class Y extends m{constructor(){super(...arguments),this.providers=new Map,this.TOKENS_KEY_PREFIX="capgo_social_login_oauth2_tokens_",this.STATE_PREFIX="capgo_social_login_oauth2_state_"}async initializeProviders(e){var o,t,r,i;for(const[n,a]of Object.entries(e)){if(!a.appId||!a.authorizationBaseUrl||!a.redirectUrl)throw new Error(`OAuth2 provider '${n}' requires appId, authorizationBaseUrl, and redirectUrl`);const s=Object.assign(Object.assign({},a),{responseType:(o=a.responseType)!==null&&o!==void 0?o:"code",pkceEnabled:(t=a.pkceEnabled)!==null&&t!==void 0?t:!0,scope:(r=a.scope)!==null&&r!==void 0?r:"",logsEnabled:(i=a.logsEnabled)!==null&&i!==void 0?i:!1});this.providers.set(n,s),s.logsEnabled&&console.log(`[OAuth2:${n}] Initialized with config:`,{appId:a.appId,authorizationBaseUrl:a.authorizationBaseUrl,redirectUrl:a.redirectUrl,responseType:s.responseType,pkceEnabled:s.pkceEnabled})}}getProvider(e){const o=this.providers.get(e);if(!o)throw new Error(`OAuth2 provider '${e}' not configured. Call initialize() first.`);return o}getTokensKey(e){return`${this.TOKENS_KEY_PREFIX}${e}`}async login(e){var o,t,r,i;const{providerId:n}=e,a=this.getProvider(n),s=(o=e.redirectUrl)!==null&&o!==void 0?o:a.redirectUrl,l=(t=e.scope)!==null&&t!==void 0?t:a.scope,c=(r=e.state)!==null&&r!==void 0?r:this.generateState(),y=(i=e.codeVerifier)!==null&&i!==void 0?i:this.generateCodeVerifier(),f=new URLSearchParams({response_type:a.responseType,client_id:a.appId,redirect_uri:s,state:c});if(l&&f.set("scope",l),a.responseType==="code"&&a.pkceEnabled){const v=await this.generateCodeChallenge(y);f.set("code_challenge",v),f.set("code_challenge_method","S256")}if(a.additionalParameters)for(const[v,E]of Object.entries(a.additionalParameters))f.set(v,E);if(e.additionalParameters)for(const[v,E]of Object.entries(e.additionalParameters))f.set(v,E);this.persistPendingLogin(c,{providerId:n,codeVerifier:y,redirectUri:s,scope:l}),localStorage.setItem(m.OAUTH_STATE_KEY,JSON.stringify({provider:"oauth2",providerId:n,state:c}));const k=`${a.authorizationBaseUrl}?${f.toString()}`;a.logsEnabled&&console.log(`[OAuth2:${n}] Opening authorization URL:`,k);const A=500,u=650,b=window.screenX+(window.outerWidth-A)/2,O=window.screenY+(window.outerHeight-u)/2,I=window.open(k,"OAuth2Login",`width=${A},height=${u},left=${b},top=${O},popup=1`);return new Promise((v,E)=>{if(!I){E(new Error("Unable to open login window. Please allow popups."));return}const U=`oauth2_${c}`;let P=null;try{P=new BroadcastChannel(U)}catch{a.logsEnabled&&console.log(`[OAuth2:${n}] BroadcastChannel not supported, using postMessage only`)}const g=(d,h,L)=>{window.removeEventListener("message",d),clearTimeout(h),clearInterval(L),P&&P.close()},_=d=>{if(d?.type==="oauth-response"){if(d?.provider&&d.provider!=="oauth2"||d?.providerId&&d.providerId!==n)return!1;g(p,w,S);const h=d,{provider:L,type:$}=h,x=j(h,["provider","type"]);return v({provider:"oauth2",result:x}),!0}else if(d?.type==="oauth-error")return d?.provider&&d.provider!=="oauth2"?!1:(g(p,w,S),E(new Error(d.error||"OAuth2 login was cancelled.")),!0);return!1};P&&(P.onmessage=d=>{_(d.data)});const p=d=>{d.origin===window.location.origin&&_(d.data)};window.addEventListener("message",p);const w=window.setTimeout(()=>{g(p,w,S);try{I.close()}catch{}E(new Error("OAuth2 login timed out."))},3e5),S=window.setInterval(()=>{try{I.closed&&(g(p,w,S),E(new Error("OAuth2 login window was closed.")))}catch{clearInterval(S),a.logsEnabled&&console.log(`[OAuth2:${n}] Cannot check popup.closed due to cross-origin restrictions. Relying on message handlers and timeout.`)}},1e3)})}async logout(e){const o=this.providers.get(e);localStorage.removeItem(this.getTokensKey(e)),o?.logoutUrl&&window.open(o.logoutUrl,"_blank")}async isLoggedIn(e){const o=this.getStoredTokens(e);if(!o)return{isLoggedIn:!1};const t=o.expiresAt>Date.now();return t||localStorage.removeItem(this.getTokensKey(e)),{isLoggedIn:t}}async getAuthorizationCode(e){const o=this.getStoredTokens(e);if(!o)throw new Error(`OAuth2 access token is not available for provider '${e}'.`);return{accessToken:o.accessToken,jwt:o.idToken}}async refresh(e){const o=this.getStoredTokens(e);if(!o?.refreshToken)throw new Error(`No OAuth2 refresh token is available for provider '${e}'. Include offline_access scope to receive one.`);if(!this.getProvider(e).accessTokenEndpoint)throw new Error(`No accessTokenEndpoint configured for provider '${e}'.`);await this.refreshWithRefreshToken(e,o.refreshToken)}async handleOAuthRedirect(e,o){var t,r,i,n,a;const s=new URLSearchParams(e.search);new URLSearchParams(e.hash.slice(1)).forEach((u,b)=>{s.set(b,u)});const c=o??s.get("state");if(!c)return null;const y=this.consumePendingLogin(c);if(!y)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:"OAuth2 login session expired or state mismatch."};const{providerId:f}=y,k=this.providers.get(f);if(!k)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:`OAuth2 provider '${f}' configuration not found.`};const A=s.get("error");if(A)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:s.get("error_description")||A};try{let u;if(s.has("code")){const v=s.get("code");if(!v)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:"OAuth2 authorization code missing from redirect."};u=await this.exchangeAuthorizationCode(f,v,y)}else if(s.has("access_token"))u={access_token:s.get("access_token"),token_type:s.get("token_type")||"bearer",expires_in:s.has("expires_in")?parseInt(s.get("expires_in"),10):void 0,scope:s.get("scope")||void 0,id_token:s.get("id_token")||void 0};else return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:"No authorization code or access token in redirect."};const b=u.expires_in?Date.now()+u.expires_in*1e3:Date.now()+36e5,O=(r=(t=u.scope)===null||t===void 0?void 0:t.split(" ").filter(Boolean))!==null&&r!==void 0?r:[];let I=null;return k.resourceUrl&&(I=await this.fetchResource(f,u.access_token)),this.persistTokens(f,{accessToken:u.access_token,refreshToken:u.refresh_token,idToken:u.id_token,expiresAt:b,scope:O,tokenType:u.token_type}),{provider:"oauth2",result:{providerId:f,accessToken:{token:u.access_token,tokenType:u.token_type,expires:new Date(b).toISOString(),refreshToken:u.refresh_token},idToken:(i=u.id_token)!==null&&i!==void 0?i:null,refreshToken:(n=u.refresh_token)!==null&&n!==void 0?n:null,resourceData:I,scope:O,tokenType:u.token_type,expiresIn:(a=u.expires_in)!==null&&a!==void 0?a:null}}}catch(u){return u instanceof Error?{error:u.message}:{error:"OAuth2 login failed unexpectedly."}}finally{localStorage.removeItem(m.OAUTH_STATE_KEY)}}async exchangeAuthorizationCode(e,o,t){const r=this.getProvider(e);if(!r.accessTokenEndpoint)throw new Error(`No accessTokenEndpoint configured for provider '${e}'.`);const i=new URLSearchParams({grant_type:"authorization_code",client_id:r.appId,code:o,redirect_uri:t.redirectUri});r.pkceEnabled&&i.set("code_verifier",t.codeVerifier),r.logsEnabled&&console.log(`[OAuth2:${e}] Exchanging code at:`,r.accessTokenEndpoint);const n=await fetch(r.accessTokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:i.toString()});if(!n.ok){const a=await n.text();throw new Error(`OAuth2 token exchange failed (${n.status}): ${a}`)}return await n.json()}async refreshWithRefreshToken(e,o){var t,r,i;const n=this.getProvider(e);if(!n.accessTokenEndpoint)throw new Error(`No accessTokenEndpoint configured for provider '${e}'.`);const a=new URLSearchParams({grant_type:"refresh_token",refresh_token:o,client_id:n.appId}),s=await fetch(n.accessTokenEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a.toString()});if(!s.ok){const f=await s.text();throw new Error(`OAuth2 refresh failed (${s.status}): ${f}`)}const l=await s.json(),c=l.expires_in?Date.now()+l.expires_in*1e3:Date.now()+36e5,y=(r=(t=l.scope)===null||t===void 0?void 0:t.split(" ").filter(Boolean))!==null&&r!==void 0?r:[];this.persistTokens(e,{accessToken:l.access_token,refreshToken:(i=l.refresh_token)!==null&&i!==void 0?i:o,idToken:l.id_token,expiresAt:c,scope:y,tokenType:l.token_type})}async fetchResource(e,o){const t=this.getProvider(e);if(!t.resourceUrl)throw new Error(`No resourceUrl configured for provider '${e}'.`);const r={Authorization:`Bearer ${o}`};t.additionalResourceHeaders&&Object.assign(r,t.additionalResourceHeaders);const i=await fetch(t.resourceUrl,{headers:r});if(!i.ok){const n=await i.text();throw new Error(`Unable to fetch OAuth2 resource (${i.status}): ${n}`)}return await i.json()}persistTokens(e,o){localStorage.setItem(this.getTokensKey(e),JSON.stringify(o))}getStoredTokens(e){const o=localStorage.getItem(this.getTokensKey(e));if(!o)return null;try{return JSON.parse(o)}catch(t){return console.warn(`Failed to parse stored OAuth2 tokens for provider '${e}'`,t),null}}persistPendingLogin(e,o){localStorage.setItem(`${this.STATE_PREFIX}${e}`,JSON.stringify(o))}consumePendingLogin(e){const o=`${this.STATE_PREFIX}${e}`,t=localStorage.getItem(o);if(localStorage.removeItem(o),!t)return null;try{return JSON.parse(t)}catch(r){return console.warn("Failed to parse pending OAuth2 login payload",r),null}}generateState(){return[...crypto.getRandomValues(new Uint8Array(16))].map(e=>e.toString(16).padStart(2,"0")).join("")}generateCodeVerifier(){const e=new Uint8Array(64);return crypto.getRandomValues(e),Array.from(e).map(o=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~"[o%66]).join("")}async generateCodeChallenge(e){const t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return this.base64UrlEncode(new Uint8Array(r))}base64UrlEncode(e){let o="";return e.forEach(t=>o+=String.fromCharCode(t)),btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}}var H=function(T,e){var o={};for(var t in T)Object.prototype.hasOwnProperty.call(T,t)&&e.indexOf(t)<0&&(o[t]=T[t]);if(T!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,t=Object.getOwnPropertySymbols(T);r<t.length;r++)e.indexOf(t[r])<0&&Object.prototype.propertyIsEnumerable.call(T,t[r])&&(o[t[r]]=T[t[r]]);return o};class D extends m{constructor(){super(...arguments),this.clientId=null,this.redirectUrl=null,this.defaultScopes=["tweet.read","users.read"],this.forceLogin=!1,this.TOKENS_KEY="capgo_social_login_twitter_tokens_v1",this.STATE_PREFIX="capgo_social_login_twitter_state_"}async initialize(e,o,t,r,i){this.clientId=e,this.redirectUrl=o??null,t?.length&&(this.defaultScopes=t),this.forceLogin=r??!1,this.audience=i??void 0}async login(e){var o,t,r,i,n,a;if(!this.clientId)throw new Error("Twitter Client ID not configured. Call initialize() first.");const s=(t=(o=e.redirectUrl)!==null&&o!==void 0?o:this.redirectUrl)!==null&&t!==void 0?t:window.location.origin+window.location.pathname,l=!((r=e.scopes)===null||r===void 0)&&r.length?e.scopes:this.defaultScopes,c=(i=e.state)!==null&&i!==void 0?i:this.generateState(),y=(n=e.codeVerifier)!==null&&n!==void 0?n:this.generateCodeVerifier(),f=await this.generateCodeChallenge(y);this.persistPendingLogin(c,{codeVerifier:y,redirectUri:s,scopes:l}),localStorage.setItem(m.OAUTH_STATE_KEY,JSON.stringify({provider:"twitter",state:c}));const k=new URLSearchParams({response_type:"code",client_id:this.clientId,redirect_uri:s,scope:l.join(" "),state:c,code_challenge:f,code_challenge_method:"S256"});((a=e.forceLogin)!==null&&a!==void 0?a:this.forceLogin)===!0&&k.set("force_login","true"),this.audience&&k.set("audience",this.audience);const A=`https://x.com/i/oauth2/authorize?${k.toString()}`,u=500,b=650,O=window.screenX+(window.outerWidth-u)/2,I=window.screenY+(window.outerHeight-b)/2,v=window.open(A,"XLogin",`width=${u},height=${b},left=${O},top=${I},popup=1`);return new Promise((E,U)=>{if(!v){U(new Error("Unable to open login window. Please allow popups."));return}const P=`twitter_oauth_${c}`;let g=null;try{g=new BroadcastChannel(P)}catch{}const _=(h,L,$)=>{window.removeEventListener("message",h),clearTimeout(L),clearInterval($),g&&g.close()},p=h=>{if(h?.type==="oauth-response"){if(h?.provider&&h.provider!=="twitter")return!1;_(w,S,d);const L=h,{provider:$,type:x}=L,N=H(L,["provider","type"]);return E({provider:"twitter",result:N}),!0}else if(h?.type==="oauth-error")return h?.provider&&h.provider!=="twitter"?!1:(_(w,S,d),U(new Error(h.error||"Twitter login was cancelled.")),!0);return!1};g&&(g.onmessage=h=>{p(h.data)});const w=h=>{h.origin===window.location.origin&&p(h.data)};window.addEventListener("message",w);const S=window.setTimeout(()=>{_(w,S,d);try{v.close()}catch{}U(new Error("Twitter login timed out."))},3e5),d=window.setInterval(()=>{try{v.closed&&(_(w,S,d),U(new Error("Twitter login window was closed.")))}catch{clearInterval(d)}},1e3)})}async logout(){localStorage.removeItem(this.TOKENS_KEY)}async isLoggedIn(){const e=this.getStoredTokens();if(!e)return{isLoggedIn:!1};const o=e.expiresAt>Date.now();return o||localStorage.removeItem(this.TOKENS_KEY),{isLoggedIn:o}}async getAuthorizationCode(){const e=this.getStoredTokens();if(!e)throw new Error("Twitter access token is not available.");return{accessToken:e.accessToken}}async refresh(){const e=this.getStoredTokens();if(!e?.refreshToken)throw new Error("No Twitter refresh token is available. Include offline.access scope to receive one.");await this.refreshWithRefreshToken(e.refreshToken)}async handleOAuthRedirect(e,o){const t=e.searchParams,r=o??t.get("state");if(!r)return null;const i=this.consumePendingLogin(r);if(!i)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:"Twitter login session expired or state mismatch."};const n=t.get("error");if(n)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:t.get("error_description")||n};const a=t.get("code");if(!a)return localStorage.removeItem(m.OAUTH_STATE_KEY),{error:"Twitter authorization code missing from redirect."};try{const s=await this.exchangeAuthorizationCode(a,i),l=await this.fetchProfile(s.access_token),c=Date.now()+s.expires_in*1e3,y=s.scope.split(" ").filter(Boolean);return this.persistTokens({accessToken:s.access_token,refreshToken:s.refresh_token,expiresAt:c,scope:y,tokenType:s.token_type,userId:l.id,profile:l}),{provider:"twitter",result:{accessToken:{token:s.access_token,tokenType:s.token_type,expires:new Date(c).toISOString(),userId:l.id},refreshToken:s.refresh_token,scope:y,tokenType:s.token_type,expiresIn:s.expires_in,profile:l}}}catch(s){return s instanceof Error?{error:s.message}:{error:"Twitter login failed unexpectedly."}}finally{localStorage.removeItem(m.OAUTH_STATE_KEY)}}async exchangeAuthorizationCode(e,o){var t;const r=new URLSearchParams({grant_type:"authorization_code",client_id:(t=this.clientId)!==null&&t!==void 0?t:"",code:e,redirect_uri:o.redirectUri,code_verifier:o.codeVerifier}),i=await fetch("https://api.x.com/2/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()});if(!i.ok){const n=await i.text();throw new Error(`Twitter token exchange failed (${i.status}): ${n}`)}return await i.json()}async refreshWithRefreshToken(e){var o,t;const r=new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:(o=this.clientId)!==null&&o!==void 0?o:""}),i=await fetch("https://api.x.com/2/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r.toString()});if(!i.ok){const c=await i.text();throw new Error(`Twitter refresh failed (${i.status}): ${c}`)}const n=await i.json(),a=await this.fetchProfile(n.access_token),s=Date.now()+n.expires_in*1e3,l=n.scope.split(" ").filter(Boolean);this.persistTokens({accessToken:n.access_token,refreshToken:(t=n.refresh_token)!==null&&t!==void 0?t:e,expiresAt:s,scope:l,tokenType:n.token_type,userId:a.id,profile:a})}async fetchProfile(e){var o,t,r,i;const a=await fetch(`https://api.x.com/2/users/me?user.fields=${["profile_image_url","verified","name","username"].join(",")}`,{headers:{Authorization:`Bearer ${e}`}});if(!a.ok){const l=await a.text();throw new Error(`Unable to fetch Twitter profile (${a.status}): ${l}`)}const s=await a.json();if(!s.data)throw new Error("Twitter profile payload is missing data.");return{id:s.data.id,username:s.data.username,name:(o=s.data.name)!==null&&o!==void 0?o:null,profileImageUrl:(t=s.data.profile_image_url)!==null&&t!==void 0?t:null,verified:(r=s.data.verified)!==null&&r!==void 0?r:!1,email:(i=s.data.email)!==null&&i!==void 0?i:null}}persistTokens(e){localStorage.setItem(this.TOKENS_KEY,JSON.stringify(e))}getStoredTokens(){const e=localStorage.getItem(this.TOKENS_KEY);if(!e)return null;try{return JSON.parse(e)}catch(o){return console.warn("Failed to parse stored Twitter tokens",o),null}}persistPendingLogin(e,o){localStorage.setItem(`${this.STATE_PREFIX}${e}`,JSON.stringify(o))}consumePendingLogin(e){const o=`${this.STATE_PREFIX}${e}`,t=localStorage.getItem(o);if(localStorage.removeItem(o),!t)return null;try{return JSON.parse(t)}catch(r){return console.warn("Failed to parse pending Twitter login payload",r),null}}generateState(){return[...crypto.getRandomValues(new Uint8Array(16))].map(e=>e.toString(16).padStart(2,"0")).join("")}generateCodeVerifier(){const e=new Uint8Array(64);return crypto.getRandomValues(e),Array.from(e).map(o=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~"[o%66]).join("")}async generateCodeChallenge(e){const t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return this.base64UrlEncode(new Uint8Array(r))}base64UrlEncode(e){let o="";return e.forEach(t=>o+=String.fromCharCode(t)),btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}}class R extends C{constructor(){super(),this.googleProvider=new G,this.appleProvider=new z,this.facebookProvider=new K,this.twitterProvider=new D,this.oauth2Provider=new Y,localStorage.getItem(R.OAUTH_STATE_KEY)&&(console.log("OAUTH_STATE_KEY found"),this.handleOAuthRedirect().catch(e=>{console.error("Failed to finish OAuth redirect",e),window.close()}))}async handleOAuthRedirect(){var e;const o=new URL(window.location.href),t=localStorage.getItem(R.OAUTH_STATE_KEY);let r=null,i,n;if(t)try{const l=JSON.parse(t);r=(e=l.provider)!==null&&e!==void 0?e:null,i=l.state,n=l.nonce}catch{r=t==="true"?"google":null}let a=null;switch(r){case"twitter":a=await this.twitterProvider.handleOAuthRedirect(o,i);break;case"oauth2":a=await this.oauth2Provider.handleOAuthRedirect(o,i);break;default:a=this.googleProvider.handleOAuthRedirect(o);break}if(!a)return;let s;"error"in a?s={type:"oauth-error",provider:r??null,error:a.error}:s=Object.assign({type:"oauth-response",provider:a.provider},a.result);try{window.opener&&window.opener.postMessage(s,window.location.origin)}catch{console.log("postMessage to opener failed, using BroadcastChannel")}try{let l=null;if(r==="oauth2"&&i?l=`oauth2_${i}`:r==="twitter"&&i?l=`twitter_oauth_${i}`:r==="google"&&n&&(l=`google_oauth_${n}`),l){const c=new BroadcastChannel(l);c.postMessage(s),c.close()}}catch{console.log("BroadcastChannel not available")}window.close()}async initialize(e){var o,t,r,i;const n=[];!((o=e.google)===null||o===void 0)&&o.webClientId&&n.push(this.googleProvider.initialize(e.google.webClientId,e.google.mode,e.google.hostedDomain,e.google.redirectUrl)),!((t=e.apple)===null||t===void 0)&&t.clientId&&n.push(this.appleProvider.initialize(e.apple.clientId,e.apple.redirectUrl,e.apple.useProperTokenExchange)),!((r=e.facebook)===null||r===void 0)&&r.appId&&n.push(this.facebookProvider.initialize(e.facebook.appId,e.facebook.locale)),!((i=e.twitter)===null||i===void 0)&&i.clientId&&n.push(this.twitterProvider.initialize(e.twitter.clientId,e.twitter.redirectUrl,e.twitter.defaultScopes,e.twitter.forceLogin,e.twitter.audience)),e.oauth2&&Object.keys(e.oauth2).length>0&&n.push(this.oauth2Provider.initializeProviders(e.oauth2)),await Promise.all(n)}async login(e){switch(e.provider){case"google":return this.googleProvider.login(e.options);case"apple":return this.appleProvider.login(e.options);case"facebook":return this.facebookProvider.login(e.options);case"twitter":return this.twitterProvider.login(e.options);case"oauth2":return this.oauth2Provider.login(e.options);default:throw new Error(`Login for ${e.provider} is not implemented on web`)}}async logout(e){switch(e.provider){case"google":return this.googleProvider.logout();case"apple":return this.appleProvider.logout();case"facebook":return this.facebookProvider.logout();case"twitter":return this.twitterProvider.logout();case"oauth2":if(!e.providerId)throw new Error("providerId is required for oauth2 logout");return this.oauth2Provider.logout(e.providerId);default:throw new Error(`Logout for ${e.provider} is not implemented`)}}async isLoggedIn(e){switch(e.provider){case"google":return this.googleProvider.isLoggedIn();case"apple":return this.appleProvider.isLoggedIn();case"facebook":return this.facebookProvider.isLoggedIn();case"twitter":return this.twitterProvider.isLoggedIn();case"oauth2":if(!e.providerId)throw new Error("providerId is required for oauth2 isLoggedIn");return this.oauth2Provider.isLoggedIn(e.providerId);default:throw new Error(`isLoggedIn for ${e.provider} is not implemented`)}}async getAuthorizationCode(e){switch(e.provider){case"google":return this.googleProvider.getAuthorizationCode();case"apple":return this.appleProvider.getAuthorizationCode();case"facebook":return this.facebookProvider.getAuthorizationCode();case"twitter":return this.twitterProvider.getAuthorizationCode();case"oauth2":if(!e.providerId)throw new Error("providerId is required for oauth2 getAuthorizationCode");return this.oauth2Provider.getAuthorizationCode(e.providerId);default:throw new Error(`getAuthorizationCode for ${e.provider} is not implemented`)}}async refresh(e){switch(e.provider){case"google":return this.googleProvider.refresh();case"apple":return this.appleProvider.refresh();case"facebook":return this.facebookProvider.refresh(e.options);case"twitter":return this.twitterProvider.refresh();case"oauth2":{const o=e.options;if(!o?.providerId)throw new Error("providerId is required for oauth2 refresh");return this.oauth2Provider.refresh(o.providerId)}default:throw new Error(`Refresh for ${e.provider} is not implemented`)}}async providerSpecificCall(e){throw new Error(`Provider specific call for ${e.call} is not implemented`)}async getPluginVersion(){return{version:"web"}}async openSecureWindow(e){const r=[["width",600],["height",550],["left",screen.width/2-300],["top",screen.height/2-275]].map(n=>n.join("=")).join(","),i=window.open(e.authEndpoint,"Authorization",r);return typeof i.focus=="function"&&i.focus(),new Promise((n,a)=>{const s=new BroadcastChannel(e.broadcastChannelName||"oauth-channel");s.addEventListener("message",l=>{l.data.startsWith(e.redirectUri)?(s.close(),n({redirectedUri:l.data})):(s.close(),a(new Error("Redirect URI does not match, expected "+e.redirectUri+" but got "+l.data)))}),setTimeout(()=>{s.close(),a(new Error("The sign-in flow timed out"))},5*6e4)})}}R.OAUTH_STATE_KEY="social_login_oauth_pending";export{R as SocialLoginWeb};
//# sourceMappingURL=web-CIzsfaeL.js.map
