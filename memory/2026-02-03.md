# 2026-02-03 - Scrape masivo SoFIFA + limpieza Firebase

## Scrape SoFIFA EA FC 26 ‚úÖ
- **33 ligas, 456 equipos, 12.654 jugadores** scrapeados de SoFIFA
- Premier League incluida (faltaba del primer intento)
- Ratings oficiales EA FC 26: Isco 84, Alaba 81, Cancelo 84, Huijsen 82, G√ºler 82
- Valores de mercado realistas: Mbapp√© ‚Ç¨153M, Bellingham ‚Ç¨182M, Courtois ‚Ç¨24M
- MLS y Saudi Pro League a√±adidas como ligas nuevas

## Limpieza Firebase ‚úÖ
- 919 equipos + 36 ligas borrados
- Re-subido todo desde cero (sin duplicados)
- ATM/Madrid resuelto (no m√°s duplicados)
- Legan√©s/Las Palmas eliminados de LaLiga (equipos fantasma)

## Bug conocido SoFIFA
- Elche, Levante, Oviedo, Getafe, Alav√©s aparecen en LaLiga en SoFIFA pero deber√≠an estar en Segunda
- Viene del scrape de SoFIFA que los pone en lg=53 (LaLiga)
- Pendiente de resolver

## Traducciones completadas ‚úÖ
- Score ‚Üí Puntuaci√≥n
- GAME OVER ‚Üí FIN DEL JUEGO
- Naming Rights ‚Üí Derechos de Nombre
- W/D/L ‚Üí V/E/D
- Stats Squad en espa√±ol
- Unknown ‚Üí Desconocido

## Fix valores de mercado en TransfersV2
- Bug: `calculateMarketValue(player, playerLeagueId)` usaba la liga del USUARIO (ej: segundaRFEF ‚Üí tier 5 ‚Üí x0.04) para mostrar valores de jugadores de OTROS equipos
- Fix: ExplorarTab usa `selectedLeague`, BuscarTab usa `player.leagueId`, modal usa `player.leagueId || state.leagueId`
- Los JSON s√≠ tienen valores correctos (Mbapp√© ‚Ç¨149M) pero el frontend los recalculaba mal

## Refactor Mercado estilo PC F√∫tbol 5.0 ‚úÖ COMPLETADO
- **Mercado siempre abierto** ‚Äî `isTransferWindowOpen()` devuelve siempre `{ open: true }`
- **Botones simular**: "3 partidos" / "Media temporada" / "Final de temporada" (eliminado mercado invierno)
- **Ofertas diferidas**: env√≠as oferta ‚Üí pendiente ‚Üí respuesta tras simular partido
- **Respuesta dual**: üè¢ Club (acepta/rechaza/contraoferta) + üë§ Jugador (acepta/rechaza)
- **Bloqueo de dinero**: se descuenta al enviar oferta, se devuelve si rechazan
- **Caducidad ofertas enviadas**: 1-3 semanas seg√∫n ratio oferta/valor (altas=3, medias=2, bajas=1)
- **Caducidad ofertas recibidas**: 1-2 semanas con indicador visual ‚ö†Ô∏è
- **Contraofertas**: caducan en 2 semanas, al aceptar solo descuenta la diferencia
- **448 l√≠neas de negociaci√≥n multi-paso eliminadas** (handleClubOffer, handlePlayerOffer, rondas, etc)
- **PlayerModal simplificado**: precio + salario + contrato ‚Üí un solo bot√≥n "Enviar oferta"
- **MisOfertasTab redise√±ada**: cards con respuesta dual (offer-card-v2)
- **Eliminados**: banners/estilos mercado invierno de Sidebar, MobileNav, Office
- **Archivos modificados**: globalTransferEngine.js, GameContext.jsx, Office.jsx, MobileNav.jsx, Sidebar.jsx, TransfersV2.jsx, locales/{es,en,de,fr,it,pt}.json

## Notas t√©cnicas importantes
- `allPlayers` memo en TransfersV2 ahora incluye `leagueId: team.leagueId` por jugador
- `ACCEPT_COUNTER_OFFER` en GameContext solo descuenta `extraCost = finalAmount - offer.amount` (diferencia)
- `ADD_OUTGOING_OFFER` descuenta `action.payload.amount` de `state.money`
- `finalMoney` en ADVANCE_WEEK cambiado de `const` a `let` para permitir devoluciones
- Ofertas resueltas se auto-limpian tras 3 semanas
- `getWinterWindowRange()` sigue existiendo en globalTransferEngine pero ya no se usa activamente

## Pendientes
- Firebase Security Rules para `contrarreloj_ranking`
- Restricci√≥n API key Firebase (Google Cloud Console)
- Firebase index para `getCountFromServer` con `where` en ranking
- Fix ligas SoFIFA (equipos en liga incorrecta)
- Deploy pendiente (build pasa ‚úÖ, Pol a√∫n no ha probado en local)
